ns try_test;

deftype alias Error = string

deftype Foo = {
  a: bool
}

fn canFailInt(): Result[int, Error] { .Ok(42) }
fn canFailBool(): Result[bool, Error] { .Ok(false) }

impl Try[T = int, E = Error] for Foo {
  fn error(_e: E): Self   { { a: false } }
  fn value(_t: T): Self { { a: true  } }

  fn isOk(self: Self): bool { self.a }
  fn getValue(_self: Self): T  { 3 }
  fn getError(_self: Self): E { "FooError" }
}

fn fails(): Result[bool, Error] {
  let value: Result[int, Error] = .Err("woops");
  let i = value.try;
  .Ok(i % 2 == 0)
}

fn run(): Result[i32, Error] {
  let result: int = canFailInt().try;
  assert(result == 42);
  let result: int = ({ a: true }: Foo).try;
  assert(result == 3);

  let c = \(-> Result[bool, Error]) {
    let i = fails().try;
    .Ok(not i)
  };
  let res = c();
  assert(res is .Err("woops"));

  .Ok(0)
}

fn test() {
  assert(run().isOk());
}
