use core/Arena

let MODULE_INFO: core/k1/ModuleManifest = {
  let* m = core/mem/zeroed[core/k1/ModuleManifest]();
  m.multithreading* <- true;
  m.kind* <- .Executable;
  m.*
};

let* tls myvar: *mut i32 = 0;

fn run(input: *mut iword): ptr {
  let value = myvar.*;
  assertEquals(input.*, 42);
  myvar <- myvar.* + 1;
  input <- input.* + 1;
  assertEquals(myvar.*, 1);
  input as ptr
}

fn main(): i32 {
  myvar <- 1000;
  let* arena = Arena/default();
  let input = arena.push(42);
  let output = arena.pushUninit[*int]();

  let thread = std/thread/start(arena, run.toRef(), input);
  std/thread/join(thread.*, output);

  // output returned has been incremented 
  assertEquals(input as ptr, output.* as ptr);
  assertEquals(output.*.*, 43);

  // myvar is unchanged by the thread since its threadlocal
  assertEquals(myvar.*, 1000);
  0
}
